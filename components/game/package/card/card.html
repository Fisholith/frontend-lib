<app-card
	class="game-package-card"
	:id="`game-package-card-${package.id}`"
	>

	<div
		class="game-package-card-pricing fill-gray"
		:class="{ 'game-package-card-pricing-owned fill-green': isOwned }"
		>

		<!-- If they own the package -->
		<div v-if="isOwned">
			<strong class="text-upper">
				<translate>Owned</translate>
			</strong>
		</div>

		<!-- If they don't own the package yet. -->
		<div v-else>

			<!-- Fixed Pricing -->
			<div v-if="sellable.type === 'paid'">
				<span class="game-package-card-pricing-sale-percentage"
					v-if="sale"
					>
					-{{ salePercentageOff }}%
				</span>
				<strong class="game-package-card-pricing-amount">
					{{ integer( pricing ) | currency( undefined, 0 ) }}<span class="game-package-card-pricing-decimal">.{{ decimal( pricing ) }}</span>
				</strong>
				<span class="game-package-card-pricing-amount game-package-card-pricing-amount-old"
					v-if="sale"
					>
					{{ integer( saleOldPricing ) | currency( undefined, 0 ) }}<span class="game-package-card-pricing-decimal">.{{ decimal( saleOldPricing ) }}</span>
				</span>
				<br><span class="game-package-card-pricing-tag muted">or more</span>
			</div>

			<!-- Pay What You Want -->
			<div v-if="sellable.type === 'pwyw'">
				<translate class="game-package-card-pricing-tag text-lower">
					Name Your Price
				</translate>
			</div>

			<!-- Free/Default -->
			<div v-if="sellable.type === 'free'">
				<strong class="game-package-card-pricing-amount text-upper">
					<translate>Free</translate>
				</strong>
			</div>
		</div>

	</div>

	<div class="card-title">
		<h4>
			{{ (package.title || game.title) }}
		</h4>
	</div>

	<div class="card-meta card-meta-sm">

		<!--
			In client, if the game is installed.
		-->
		<span v-if="localPackage">

			<!-- Reduce number of watches -->
			<span v-if="localPackage.isInstalling()">
				<span v-if="!localPackage.isPatchPaused()">
					<translate class="tag tag-blue text-upper" v-if="localPackage.isInstalling()">Installing</translate>
					<translate class="tag tag-pink text-upper" v-if="localPackage.didInstallFail()">Install Failed</translate>
				</span>
				<span v-if="localPackage.isPatchPaused()">
					<translate class="tag text-upper">Install Paused</translate>
				</span>
			</span>
			<span v-if="localPackage.isUpdating()">
				<span v-if="!localPackage.isPatchPaused()">
					<translate class="tag tag-blue text-upper" v-if="localPackage.isUpdating()">Updating</translate>
					<translate class="tag tag-pink text-upper" v-if="localPackage.didUpdateFail()">Update Failed</translate>
				</span>
				<span v-if="localPackage.isPatchPaused()">
					<translate class="tag text-upper">Update Paused</translate>
				</span>
			</span>
			<translate class="tag tag-active text-upper" v-if="localPackage.isSettled() && !localPackage.isRunning()">Installed</translate>
			<translate class="tag tag-active text-upper" v-if="localPackage.isRunning()">Running</translate>
			<translate class="tag text-upper" v-if="localPackage.isRemoving()">Removing</translate>
			<span class="dot-separator"></span>
		</span>

		<app-jolticon
			v-for="supportKey of card.platformSupport"
			:icon="card.platformSupportInfo[ supportKey ].icon"
			v-app-tooltip="card.platformSupportInfo[ supportKey ].tooltip"
			/>

		<span class="dot-separator" v-if="card.platformSupport.length"></span>

		<span v-if="card.showcasedRelease">
			<translate>Version:</translate>
			<strong>{{ card.showcasedRelease.version_number }}</strong>

			<span class="dot-separator"></span>

			<app-time-ago :date="card.showcasedRelease.published_on" />
		</span>
	</div>

	<div class="card-content card-sale-info" v-if="sale">
		<strong><translate>On sale!</translate></strong>
		<translate>Offer ends in</translate>
		<app-countdown :end="pricing.end" />
	</div>

	<div class="card-content" v-if="package.description">
		<app-fade-collapse
			:collapse-height="100"
			:is-open="showFullDescription"
			@require-change="canToggleDescription = $event"
			>

			<!--TODO: This used to link-->
			<div v-html="package.description"></div>

		</app-fade-collapse>

		<a class="hidden-text-expander"
			v-if="canToggleDescription"
			@click="showFullDescription = !showFullDescription"
			v-app-track-event="`game-package-card:show-full-description`"
			>
		</a>
	</div>

	<div v-if="!card.showcasedRelease">
		<br>
		<div class="alert alert-warning">
			<translate>No published releases yet.</translate>
		</div>
	</div>

	<!-- TODO(rewrite) -->
	<div v-if="hasPaymentWell">
		<app-expand :when="isPaymentOpen" class="payment-well-expander">
			<div class="payment-well fill-dark">

				<!--<gj-game-package-card-payment-form
					game="game"
					package="package"
					sellable="sellable"
					pricing="pricing"
					partner-referred-key="partnerReferredKey"
					partner-referred-by="partnerReferredBy"
					partner-no-cut="partnerNoCut"
					on-bought="onPackageBought()"
					>
				</gj-game-package-card-payment-form>-->

				<div v-if="sellable.type == 'pwyw'">
					<hr>
					<app-jolticon class="middle" icon="chevron-right" />
					<a class="link-unstyled small"
						@click="skipPayment"
						>
						<translate v-if="!GJ_IS_CLIENT">No thanks, take me to the download.</translate>
						<translate v-else>No thanks, just install it.</translate>
					</a>
				</div>
			</div>
		</app-expand>
	</div>

	<div class="card-controls" v-if="card.showcasedRelease">

		<div v-if="sellable.type !== 'paid' || isOwned || isPartner">

			<!--
				The buttons are so different for client that we put them in a child component.
				They will only be available on WTTF since they're pushed in the client component there.'
			-->
			<div v-if="GJ_IS_CLIENT">
				<!--<gj-client-package-card-buttons></gj-client-package-card-buttons>-->
			</div>

			<app-game-package-card-buttons
				v-else
				:package="package"
				:card="card"
				@click="buildClick( $event.build, $event.fromExtraSection )"
				/>

			<div v-if="isPartner && sellable.type === 'paid' && !isOwned">
				<br>
				<div class="alert alert-info">
					<translate>You get access to this package because you're a partner.</translate>
				</div>
				<hr>
			</div>

		</div>

		<div v-if="sellable.type === 'paid' && !isOwned">

			<!--
				Remove this as soon as we open the payment area.
			-->
			<div class="clearfix">
					<!--v-if="!isPaymentOpen"
					@click="isPaymentOpen = !isPaymentOpen"-->
				<button class="btn btn-success-outline btn-block-xs"
					@click="showPayment()"
					>
					<app-jolticon icon="heart" />
					<translate>Buy Now</translate>
				</button>

				<span class="game-package-card-payment-what-link">
					(<a class="link-help" ng-click="isWhatOpen = !isWhatOpen"><translate>What do you get?</translate></a>)
				</span>
			</div>

		</div>

	</div>

	<app-expand :when="isWhatOpen" class="payment-well-expander payment-well-expander-files">
		<div class="payment-well">

			<div v-for="build in builds" :key="build.id">

				{{ build.primary_file.filename }}
				<small class="text-muted">({{ build.primary_file.filesize | filesize }})</small>

				<span v-for="os of [ 'windows', 'mac', 'linux', 'other' ]">
					<app-jolticon
						v-if="build[ 'os_' + os ] || build[ 'os_' + os + '_64' ]"
						:icon="card.platformSupportInfo[ os ].icon"
						v-app-tooltip="card.platformSupportInfo[ os ].tooltip"
						/>
					</span>
				</span>

			</div>

			<br>

			<small><translate>And really warm feelings for supporting an indie developer!</translate></small>

		</div>
	</app-expand>

</app-card>
